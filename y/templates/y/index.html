{% extends "y/layout.html" %}

{% block body %}
  {% if user.is_authenticated %}
  <div style="background-color: white; border: 1px solid cornsilk; border-radius: 10px; padding: 15px 30px; margin-top: 20px;">
    <h3>New Post</h3>
    <form action="" method="post">
      {% csrf_token %}
      <div style="display: flex; flex-direction: column;">
      {{ postForm.content }}
      <div style="display: flex; justify-content: end; padding-top: 5px;">
        <input type="submit" name="newPost" value="Post" style="display: inline-block;">
      </div>
      </div>
    </form>
  </div>
  {% endif %}

  {% for post in posts %}
    <div style="
      background-color: white; 
      border: 1px solid cornsilk; 
      border-radius: 10px; 
      padding: 15px 30px; 
      margin-top: 20px;"

    >
      <div style="display: flex; justify-content: space-between;">
        <a href="{% url 'user' username=post.poster.username %}"><div>{{post.poster}}:</div></a>
        <div style="display: flex;">
          {% if post.poster.username == user.username %}
            <button class="editBtn" data-id="{{post.id}}" style="margin: 0 20px;">Edit</button>
          {% endif %}
          <div>{{post.date}}</div>
        </div>
      </div>
      <div class="contentDiv" data-id="{{post.id}}">
        <strong class="contentText" data-id="{{post.id}}">{{post.content}}</strong>
        <div hidden class="editArea" data-id="{{post.id}}" style="display: flex; flex-direction: column;">
          <textarea>{{post.content}}</textarea>
          <div style="display: flex; justify-content: end;">
            <button class="saveBtn" data-id="{{post.id}}">Save</button>
          </div>
        </div>
      </div>
      <div>Likes: {{ post.likes }}</div>
    </div>
  {% empty %}
    <div>No posts.</div>
  {% endfor %}

  <div style="display: flex; justify-content: space-around; margin-top: 20px;">
      <div>
      {% if previousPageNumber %}
        <a href="{% url 'indexPagination' page=previousPageNumber %}"><button style="padding: 5px 15px; margin-right: 10px;">Previous</button></a>
      {% endif %}
      {% if nextPageNumber %}
        <a href="{% url 'indexPagination' page=nextPageNumber %}"><button style="padding: 5px 15px;">Next</button></a>
      {% endif %}
      </div>
  </div>

<script>
    // Prevent resubmitting form alert
    if ( window.history.replaceState ) {
        window.history.replaceState( null, null, window.location.href );
    }

    function main() {
      const editButtons = document.querySelectorAll(".editBtn");
      const contentTexts = Array.from(document.querySelectorAll(".contentText"));
      const contentDivs = Array.from(document.querySelectorAll(".contentDiv"));
      const editAreas = Array.from(document.querySelectorAll(".editArea"));

      editButtons.forEach((btn) => {
        btn.onclick = (event) => {
          const postId = btn.dataset.id;
          const contentText = contentTexts.filter((div) => div.dataset.id === postId)[0]
          contentText.hidden = !contentText.hidden;
          
          const editArea = editAreas.filter((div) => div.dataset.id === postId)[0];
          editArea.hidden = !editArea.hidden;

          const saveBtns = Array.from(document.querySelectorAll(".saveBtn"));
          console.log(saveBtns)
          const saveBtn = saveBtns.filter((btn) => btn.dataset.id === postId)[0];
          console.log(saveBtn)
          const csrftoken = getCookie('csrftoken');

          saveBtn.onclick = async (event) => {
            const content = editArea.querySelector("textarea").value;
            console.log(content)
            const response = await fetch(`edit/${postId}`, {
              method: "PUT", 
              body: JSON.stringify({
                content: content, 
                id: postId,
              }),
              headers: {
                "X-CSRFToken": csrftoken,
              },
            })
            console.log(response)
          }


          // // create and append texarea inside
          // const textAreaWrapper = document.createElement("div");
          // textAreaWrapper.style = "display: flex; flex-direction: column;";
          // const textArea = document.createElement("textarea");
          // textArea.textContent = textContent;
          // textAreaWrapper.appendChild(textArea);
          // contentDiv.appendChild(textAreaWrapper);

          // // append save button
          // const saveBtnWrapper = document.createElement("div");
          // saveBtnWrapper.style = "display: flex; justify-content: end;";
          // const saveBtn = document.createElement("button");
          // saveBtn.textContent = "Save"
          // saveBtnWrapper.appendChild(saveBtn);
          // contentDiv.append(saveBtnWrapper);
        }
      })
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", main);
</script>

  <!-- <form action="">
    <div style="display: flex; flex-direction: column;">
    <textarea name="content" id="new-post-input" cols="100" rows="5" style="display: inline-block;"></textarea>
    <div style="display: flex; justify-content: end; padding-top: 5px;">
      <input type="submit" name="newPost" value="Post" style="display: inline-block;">
    </div>
    </div>
  </form> -->
  </div>
{% endblock %}